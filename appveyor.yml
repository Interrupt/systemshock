# Shockolate AppVeyor configuration 
# YAML format reference: https://www.appveyor.com/docs/appveyor-yml/

# This determines the disk image AppVeyor uses while building
# Despite its name, this image actually contains all sorts of non-VC goodies
# See https://www.appveyor.com/docs/build-environment/ for all the details
image: Visual Studio 2015

# Tell build_windows.sh that we're building for AppVeyor
environment:
  APPVEYOR: TRUE
  PYTHON_HOME: "C:\\Python37"
  matrix:
    - COMPILER: mingw
      ARCH: x86_64
      MINGW_DIR_BIN: C:\mingw-w64\x86_64-6.3.0-posix-seh-rt_v5-rev1\mingw64\bin
      CMAKE_C_COMPILER: C:/mingw-w64/x86_64-6.3.0-posix-seh-rt_v5-rev1/mingw64/bin/gcc.exe
      CMAKE_CXX_COMPILER: C:/mingw-w64/x86_64-6.3.0-posix-seh-rt_v5-rev1/mingw64/bin/g++.exe
    - COMPILER: mingw
      ARCH: i686
      MINGW_DIR_BIN: C:\mingw-w64\i686-6.3.0-posix-dwarf-rt_v5-rev1\mingw32\bin
      CMAKE_C_COMPILER: C:/mingw-w64/i686-6.3.0-posix-dwarf-rt_v5-rev1/mingw32/bin/gcc.exe
      CMAKE_CXX_COMPILER: C:/mingw-w64/i686-6.3.0-posix-dwarf-rt_v5-rev1/mingw32/bin/g++.exe

# Avoid rebuilding external dependencies
cache:
  - res/music.sf2

install:
  # Workaround for CMake not wanting sh.exe on PATH for MinGW
  - set PATH=%PATH:C:\Program Files\Git\usr\bin;=%
  - set PATH=%PYTHON_HOME%;%PYTHON_HOME%/Scripts/;%PATH%
  - set PATH=%MINGW_DIR_BIN%;%PATH%
  - pip.exe install conan
  - conan user
  - conan remote add bincrafters https://api.bintray.com/conan/bincrafters/public-conan
  - conan --version

build_script:
  - mkdir build
  - cd build
  - conan install .. --build=missing
  - cmake .. -DENABLE_SDL2=BUNDLED -DENABLE_SOUND=BUNDLED -DENABLE_FLUIDSYNTH=BUNDLED -G "MinGW Makefiles"
  - cmake --build .

# For now, we don't have any automatic tests to run
test: false

# Once building is done, we gather all the necessary DLL files and build our ZIP file.
after_build:
  - 7z a %ARTIFACT% systemshock.exe *.dll shaders/ res/

artifacts:
  - path: systemshock-x86.zip
    name: Shockolate (32bit)
  - path: systemshock-x64.zip
    name: Shockolate (64bit)

version: '0.5.{build}'

# Finally, we deploy the ZIP file as a GitHub release
# FIXME: How do we want to be building releases? Seems like this would be better as a manual process
# TODO: invent a better versioning scheme for the tag name

deploy:
  - provider: GitHub
    release: $(appveyor_repo_tag_name)
    description: 'Latest release build of Shockolate'
    artifact: systemshock-x86.zip, systemshock-x64.zip
    auth_token:
      secure: P1kIk8rRxKAYHqDrOWf0Zf5spfR+N86E0lO8VBu99vHtECJgPLn/Z6tBmL9cxPah  
    on:
      APPVEYOR_REPO_TAG: true
